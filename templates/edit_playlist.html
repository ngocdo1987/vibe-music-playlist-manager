<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<script>
    (function () {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-bs-theme', theme);
    })();
</script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Playlist - {{name}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .song-item {
            cursor: move;
        }

        .song-item:hover {
            background-color: var(--bs-tertiary-bg);
        }

        .upload-area {
            border: 2px dashed #0d6efd;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 2rem;
        }
    </style>
</head>

<body class="bg-body-tertiary">
    <nav class="navbar navbar-expand-lg border-bottom mb-4 bg-body">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/admin/dashboard">Admin Dashboard</a>
            <div class="ms-auto d-flex align-items-center">
                <div id="themeToggle" style="cursor:pointer">ðŸŒ“</div>
            </div>
        </div>
    </nav>

    <div class="container mb-5">
        <h2 class="mb-4">Edit: {{name}}</h2>

        <div class="upload-area" id="dropZone">
            <h5>Drag & Drop MP3 Files Here</h5>
            <p>or</p>
            <input type="file" id="fileInput" multiple accept=".mp3" class="d-none">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Browse Files</button>
            <div id="uploadStatus" class="mt-2 text-primary"></div>
        </div>

        <h4>Song Order</h4>
        <div class="list-group shadow-sm" id="songList">
            {{#songs}}
            <div class="list-group-item song-item d-flex justify-content-between align-items-center" data-id="{{id}}">
                <div>
                    <span class="me-3">â˜°</span>
                    {{title}}
                </div>
            </div>
            {{/songs}}
        </div>

        <button class="btn btn-success mt-4 w-100" id="saveOrderBtn">Save New Order</button>
        <div class="mt-3">
            <a href="/admin/dashboard" class="btn btn-link w-100">Back to Dashboard</a>
        </div>
    </div>

    <script>
        const songList = document.getElementById('songList');
        new Sortable(songList, { animation: 150 });

        const saveOrderBtn = document.getElementById('saveOrderBtn');
        saveOrderBtn.addEventListener('click', async () => {
            const songIds = Array.from(songList.children).map(el => parseInt(el.dataset.id));
            const resp = await fetch('/admin/playlist/save_order/{{id}}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ song_ids: songIds })
            });
            if (resp.ok) alert('Order saved!');
        });

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const uploadStatus = document.getElementById('uploadStatus');

        const uploadFiles = async (files) => {
            uploadStatus.textContent = "Uploading...";
            for (let file of files) {
                if (!file.name.endsWith('.mp3')) {
                    alert('Only .mp3 files are allowed!');
                    continue;
                }
                const formData = new FormData();
                formData.append('file', file);
                const resp = await fetch('/admin/upload/{{id}}', {
                    method: 'POST',
                    body: formData
                });
                if (!resp.ok) alert('Upload failed for ' + file.name);
            }
            uploadStatus.textContent = "Done! Refreshing...";
            location.reload();
        };

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.backgroundColor = 'rgba(13, 110, 253, 0.1)'; });
        dropZone.addEventListener('dragleave', () => { dropZone.style.backgroundColor = ''; });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '';
            uploadFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', () => uploadFiles(fileInput.files));

        document.getElementById('themeToggle').addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-bs-theme');
            const next = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-bs-theme', next);
            localStorage.setItem('theme', next);
        });
    </script>
</body>

</html>