# Nginx configuration for Fortran Music Manager
# Copy this file to /etc/nginx/sites-available/music-manager
# Then create symlink: ln -s /etc/nginx/sites-available/music-manager /etc/nginx/sites-enabled/

server {
    listen 80;
    server_name localhost 127.0.0.1;  # Replace with your domain

    root /home/ubuntu/projects/pet/fortran/music-manager;
    index index.html;

    # Static files
    location /static {
        alias /home/ubuntu/projects/pet/fortran/music-manager/static;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # MP3 files
    location /mp3 {
        alias /home/ubuntu/projects/pet/fortran/music-manager/public/mp3;
        expires 30d;
        add_header Cache-Control "public";
        
        # Enable range requests for audio seeking
        add_header Accept-Ranges bytes;
    }

    # PHP file upload handler
    location = /upload.php {
        include fastcgi_params;
        fastcgi_pass unix:/run/php/php-fpm.sock;  # Adjust for your PHP version
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_read_timeout 300;
    }

    # FastCGI to Fortran application
    location / {
        include fastcgi_params;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $document_root;
        
        # Increase timeouts for file uploads
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
    }

    # File upload size limit
    client_max_body_size 100M;

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_min_length 1000;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Logging
    access_log /var/log/nginx/music-manager-access.log;
    error_log /var/log/nginx/music-manager-error.log;
}
