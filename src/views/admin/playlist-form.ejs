<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= mode === 'create' ? 'Create' : 'Edit' %> Playlist - Music Playlist Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
  <style>
    .song-item {
      cursor: move;
      transition: background-color 0.2s;
    }
    .song-item:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    .song-item.dragging {
      opacity: 0.5;
    }
    [data-bs-theme="dark"] .song-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="/admin/dashboard">
        <i class="bi bi-music-note-list"></i> Music Playlist Manager
      </a>
      <div class="d-flex align-items-center">
        <button class="btn btn-outline-light me-2" id="themeToggle">
          <i class="bi bi-moon-fill" id="themeIcon"></i>
        </button>
        <a href="/admin/logout" class="btn btn-outline-light">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><%= mode === 'create' ? 'Create New' : 'Edit' %> Playlist</h2>
      <a href="/admin/dashboard" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
      </a>
    </div>

    <div class="row">
      <div class="col-lg-8">
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Playlist Information</h5>
            <form id="playlistForm">
              <div class="mb-3">
                <label for="name" class="form-label">Playlist Name *</label>
                <input type="text" class="form-control" id="name" name="name" 
                       value="<%= playlist ? playlist.name : '' %>" required>
              </div>
              
              <div class="mb-3">
                <label for="slug" class="form-label">URL Slug *</label>
                <input type="text" class="form-control" id="slug" name="slug" 
                       value="<%= playlist ? playlist.slug : '' %>" required>
                <div class="form-text">URL-friendly identifier (e.g., "chill-vibes")</div>
              </div>
              
              <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3"><%= playlist ? playlist.description || '' : '' %></textarea>
              </div>
              
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> <%= mode === 'create' ? 'Create' : 'Update' %> Playlist
              </button>
            </form>
          </div>
        </div>

        <% if (mode === 'edit') { %>
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Songs in Playlist</h5>
            
            <div id="songList" class="list-group mb-3">
              <% if (songs.length === 0) { %>
                <div class="alert alert-info">
                  <i class="bi bi-info-circle"></i> No songs yet. Upload some songs!
                </div>
              <% } else { %>
                <% songs.forEach(song => { %>
                  <div class="list-group-item song-item" draggable="true" data-song-id="<%= song.id %>">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-grip-vertical me-2"></i>
                        <div>
                          <strong><%= song.original_name %></strong>
                          <br>
                          <small class="text-muted"><%= (song.file_size / 1024 / 1024).toFixed(2) %> MB</small>
                        </div>
                      </div>
                      <button class="btn btn-sm btn-danger" onclick="removeSong(<%= song.id %>)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                <% }) %>
              <% } %>
            </div>
            
            <button class="btn btn-success" onclick="saveOrder()">
              <i class="bi bi-check-circle"></i> Save Song Order
            </button>
          </div>
        </div>
        <% } %>
      </div>

      <% if (mode === 'edit') { %>
      <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
          <div class="card-body">
            <h5 class="card-title">Upload Songs</h5>
            
            <div class="mb-3">
              <label for="songFile" class="form-label">Select MP3 Files</label>
              <input type="file" class="form-control" id="songFile" accept=".mp3" multiple>
              <div class="form-text">You can select multiple files</div>
            </div>
            
            <button class="btn btn-primary w-100" onclick="uploadSongs()">
              <i class="bi bi-upload"></i> Upload Songs
            </button>
            
            <div id="uploadProgress" class="mt-3" style="display: none;">
              <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                     style="width: 100%"></div>
              </div>
              <p class="text-center mt-2 mb-0">Uploading...</p>
            </div>
          </div>
        </div>
      </div>
      <% } %>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const mode = '<%= mode %>';
    const playlistId = <%= playlist ? playlist.id : 'null' %>;
    
    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const htmlElement = document.documentElement;
    
    const savedTheme = localStorage.getItem('theme') || 'light';
    htmlElement.setAttribute('data-bs-theme', savedTheme);
    updateThemeIcon(savedTheme);
    
    themeToggle.addEventListener('click', () => {
      const currentTheme = htmlElement.getAttribute('data-bs-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      htmlElement.setAttribute('data-bs-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    });
    
    function updateThemeIcon(theme) {
      themeIcon.className = theme === 'light' ? 'bi bi-moon-fill' : 'bi bi-sun-fill';
    }
    
    // Auto-generate slug from name
    document.getElementById('name').addEventListener('input', (e) => {
      if (mode === 'create') {
        const slug = e.target.value
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '');
        document.getElementById('slug').value = slug;
      }
    });
    
    // Playlist form submission
    document.getElementById('playlistForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      const url = mode === 'create' 
        ? '/admin/playlist/create' 
        : `/admin/playlist/update/${playlistId}`;
      
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          if (mode === 'create') {
            window.location.href = `/admin/playlist/edit/${result.playlistId}`;
          } else {
            alert('Playlist updated successfully!');
          }
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error saving playlist');
        console.error(error);
      }
    });
    
    <% if (mode === 'edit') { %>
    // Drag and drop functionality
    let draggedElement = null;
    
    const songList = document.getElementById('songList');
    const songItems = songList.querySelectorAll('.song-item');
    
    songItems.forEach(item => {
      item.addEventListener('dragstart', handleDragStart);
      item.addEventListener('dragover', handleDragOver);
      item.addEventListener('drop', handleDrop);
      item.addEventListener('dragend', handleDragEnd);
    });
    
    function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      
      const afterElement = getDragAfterElement(songList, e.clientY);
      if (afterElement == null) {
        songList.appendChild(draggedElement);
      } else {
        songList.insertBefore(draggedElement, afterElement);
      }
      
      return false;
    }
    
    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      return false;
    }
    
    function handleDragEnd(e) {
      this.classList.remove('dragging');
    }
    
    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.song-item:not(.dragging)')];
      
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    // Upload songs
    async function uploadSongs() {
      const fileInput = document.getElementById('songFile');
      const files = fileInput.files;
      
      if (files.length === 0) {
        alert('Please select at least one file');
        return;
      }
      
      document.getElementById('uploadProgress').style.display = 'block';
      
      for (let file of files) {
        if (!file.name.toLowerCase().endsWith('.mp3')) {
          alert(`File ${file.name} is not an MP3 file. Skipping...`);
          continue;
        }
        
        const formData = new FormData();
        formData.append('song', file);
        
        try {
          const response = await fetch('/admin/song/upload', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            // Add song to playlist
            const position = document.querySelectorAll('.song-item').length;
            await fetch(`/admin/playlist/${playlistId}/add-song`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                songId: result.song.id,
                position: position
              })
            });
          } else {
            alert(`Error uploading ${file.name}: ${result.error}`);
          }
        } catch (error) {
          alert(`Error uploading ${file.name}`);
          console.error(error);
        }
      }
      
      document.getElementById('uploadProgress').style.display = 'none';
      fileInput.value = '';
      window.location.reload();
    }
    
    // Remove song
    async function removeSong(songId) {
      if (!confirm('Are you sure you want to remove this song?')) {
        return;
      }
      
      try {
        const response = await fetch(`/admin/playlist/${playlistId}/remove-song/${songId}`, {
          method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
          window.location.reload();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error removing song');
        console.error(error);
      }
    }
    
    // Save song order
    async function saveOrder() {
      const songItems = document.querySelectorAll('.song-item');
      const songIds = Array.from(songItems).map(item => item.dataset.songId);
      
      try {
        const response = await fetch(`/admin/playlist/${playlistId}/reorder`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ songIds })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('Song order saved successfully!');
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error saving order');
        console.error(error);
      }
    }
    <% } %>
  </script>
</body>
</html>